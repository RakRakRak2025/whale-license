<script>
  // --- 초기 설정 ---
  let selectedAvatar = '🐋';
  let licenseNum = generateLicenseNumber();

  window.addEventListener('DOMContentLoaded', () => {
    updateLicense();
    generateBarcode();
    document.getElementById('issueDate').textContent = formatDate(new Date());
    document.getElementById('expiryDate').textContent = formatDate(getExpiryDate());
    // 관리자 버튼 노출 (기존 코드)
    const p = new URLSearchParams(location.search);
    if (p.get('admin') === '1633') document.getElementById('adminBtn').style.display = 'flex';
  });

  // --- 입력 반영 함수 ---
  function selectAvatar(avatar, el) {
    selectedAvatar = avatar;
    document.querySelectorAll('.avatar-option').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected');
    updateLicense();
  }

  function updateLicense() {
    // 이름
    const name = document.getElementById('name').value.trim() || '-';
    document.getElementById('displayName').textContent = name;
    // 생년월일
    const birth = document.getElementById('birthdate').value;
    document.getElementById('displayBirth').textContent = birth ? formatDate(birth) : '-';
    // 고래 종류
    const whale = document.getElementById('whaleType').value || '-';
    document.getElementById('displayWhale').textContent = whale;
    // 운전 목적 (이모지 제거)
    const exp = document.getElementById('experience').value || '-';
    document.getElementById('displayGrade').textContent = exp.split(' ')[0];
    // 아바타
    document.getElementById('avatarDisplay').textContent = selectedAvatar;
    // 면허번호
    document.getElementById('licenseNumber').textContent = licenseNum;
    // 바코드 재생성
    JsBarcode("#barcodeSvg", licenseNum, {
      format: "CODE128",
      width: 2,
      height: 40,
      displayValue: false
    });
  }

  // --- 바코드 생성 (초기) ---
  function generateBarcode() {
    JsBarcode("#barcodeSvg", licenseNum, {
      format: "CODE128",
      width: 2,
      height: 40,
      displayValue: false
    });
  }

  // --- 유틸리티 함수들 ---
  function generateLicenseNumber() {
    const y = new Date().getFullYear();
    const r = Math.floor(Math.random()*1e6).toString().padStart(6,'0');
    return `UW-${y}-${r}`;
  }

  function formatDate(d) {
    const dt = new Date(d);
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${dt.getFullYear()}.${mm}.${dd}`;
  }

  function getExpiryDate() {
    const dt = new Date();
    return new Date(dt.getFullYear()+5, dt.getMonth(), dt.getDate());
  }

  // --- 다운로드 (html2canvas) ---
  function downloadLicense() {
    const card = document.querySelector('.license-card');
    html2canvas(card, { backgroundColor:'#ffffff', scale:2 }).then(canvas => {
      canvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `울산고래면허증_${document.getElementById('displayName').textContent}_${licenseNum}.png`;
        a.click();
        URL.revokeObjectURL(url);
      });
    });
  }

  // (나머지 showCoupon, shareToSNS, toggleService 등 함수는 그대로 유지)
</script>
