<script>
  // --- ì´ˆê¸° ì„¤ì • ---
  let selectedAvatar = 'ğŸ‹';
  let licenseNum = generateLicenseNumber();

  window.addEventListener('DOMContentLoaded', () => {
    updateLicense();
    generateBarcode();
    document.getElementById('issueDate').textContent = formatDate(new Date());
    document.getElementById('expiryDate').textContent = formatDate(getExpiryDate());
    // ê´€ë¦¬ì ë²„íŠ¼ ë…¸ì¶œ (ê¸°ì¡´ ì½”ë“œ)
    const p = new URLSearchParams(location.search);
    if (p.get('admin') === '1633') document.getElementById('adminBtn').style.display = 'flex';
  });

  // --- ì…ë ¥ ë°˜ì˜ í•¨ìˆ˜ ---
  function selectAvatar(avatar, el) {
    selectedAvatar = avatar;
    document.querySelectorAll('.avatar-option').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected');
    updateLicense();
  }

  function updateLicense() {
    // ì´ë¦„
    const name = document.getElementById('name').value.trim() || '-';
    document.getElementById('displayName').textContent = name;
    // ìƒë…„ì›”ì¼
    const birth = document.getElementById('birthdate').value;
    document.getElementById('displayBirth').textContent = birth ? formatDate(birth) : '-';
    // ê³ ë˜ ì¢…ë¥˜
    const whale = document.getElementById('whaleType').value || '-';
    document.getElementById('displayWhale').textContent = whale;
    // ìš´ì „ ëª©ì  (ì´ëª¨ì§€ ì œê±°)
    const exp = document.getElementById('experience').value || '-';
    document.getElementById('displayGrade').textContent = exp.split(' ')[0];
    // ì•„ë°”íƒ€
    document.getElementById('avatarDisplay').textContent = selectedAvatar;
    // ë©´í—ˆë²ˆí˜¸
    document.getElementById('licenseNumber').textContent = licenseNum;
    // ë°”ì½”ë“œ ì¬ìƒì„±
    JsBarcode("#barcodeSvg", licenseNum, {
      format: "CODE128",
      width: 2,
      height: 40,
      displayValue: false
    });
  }

  // --- ë°”ì½”ë“œ ìƒì„± (ì´ˆê¸°) ---
  function generateBarcode() {
    JsBarcode("#barcodeSvg", licenseNum, {
      format: "CODE128",
      width: 2,
      height: 40,
      displayValue: false
    });
  }

  // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ---
  function generateLicenseNumber() {
    const y = new Date().getFullYear();
    const r = Math.floor(Math.random()*1e6).toString().padStart(6,'0');
    return `UW-${y}-${r}`;
  }

  function formatDate(d) {
    const dt = new Date(d);
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${dt.getFullYear()}.${mm}.${dd}`;
  }

  function getExpiryDate() {
    const dt = new Date();
    return new Date(dt.getFullYear()+5, dt.getMonth(), dt.getDate());
  }

  // --- ë‹¤ìš´ë¡œë“œ (html2canvas) ---
  function downloadLicense() {
    const card = document.querySelector('.license-card');
    html2canvas(card, { backgroundColor:'#ffffff', scale:2 }).then(canvas => {
      canvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ìš¸ì‚°ê³ ë˜ë©´í—ˆì¦_${document.getElementById('displayName').textContent}_${licenseNum}.png`;
        a.click();
        URL.revokeObjectURL(url);
      });
    });
  }

  // (ë‚˜ë¨¸ì§€ showCoupon, shareToSNS, toggleService ë“± í•¨ìˆ˜ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€)
</script>
