<button class="admin-btn" style="background: #ffc107; color: black;" onclick="exportData()">
                   📊 데이터 내보내기
               </button>
           </div>
       </div>
   </div>
   
   <!-- 쿠폰 모달 -->
   <div class="coupon-modal" id="couponModal" onclick="closeCoupon(event)">
       <div class="coupon-content">
           <h2>🎉 고래패스 혜택 사전신청!</h2>
           <p style="color: #666; margin: 10px 0;">오픈 예정 - 사전 신청하고 특별 혜택을 받으세요!</p>
           
           <form id="couponForm" style="margin-top: 20px; text-align: left;">
               <div style="margin-bottom: 15px;">
                   <label style="display: block; margin-bottom: 5px; font-weight: 600;">이름 *</label>
                   <input type="text" id="userName" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
               </div>
               
               <div style="margin-bottom: 15px;">
                   <label style="display: block; margin-bottom: 5px; font-weight: 600;">연락처 선택 *</label>
                   <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                       <label style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; text-align: center; cursor: pointer;">
                           <input type="radio" name="contactType" value="phone" checked onchange="toggleContactInput()"> 📱 휴대폰
                       </label>
                       <label style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; text-align: center; cursor: pointer;">
                           <input type="radio" name="contactType" value="kakao" onchange="toggleContactInput()"> 💬 카카오톡
                       </label>
                   </div>
                   <input type="tel" id="phoneNumber" placeholder="010-0000-0000" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                   <input type="text" id="kakaoId" placeholder="카카오톡 ID" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; display: none;">
               </div>
               
               <div style="margin-bottom: 20px;">
                   <label style="display: flex; align-items: flex-start; gap: 10px; font-size: 14px; color: #666;">
                       <input type="checkbox" id="agreeTerms" required style="margin-top: 3px;">
                       <span>
                           개인정보 수집 및 이용에 동의합니다.<br>
                           <small style="display: block; margin-top: 5px; line-height: 1.4;">
                               • 수집항목: 이름, 연락처(휴대폰 또는 카카오톡 ID)<br>
                               • 수집목적: 고래패스 쿠폰 발송 및 이벤트 안내<br>
                               • 보유기간: 서비스 종료 후 1년<br>
                               • 수집업체: 소셜마케팅연구소
                           </small>
                       </span>
                   </label>
               </div>
               
               <button type="submit" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">
                   사전신청 완료하기
               </button>
           </form>
           
           <div id="couponSuccess" style="display: none; text-align: center; padding: 20px;">
               <div style="font-size: 60px; margin-bottom: 20px;">✅</div>
               <h3>사전신청이 완료되었습니다!</h3>
               <p style="color: #666; margin-top: 10px;">고래패스 오픈 시 연락드리겠습니다.</p>
               <button onclick="closeCoupon()" style="margin-top: 20px; padding: 10px 30px; background: #6c757d; color: white; border: none; border-radius: 20px; cursor: pointer;">닫기</button>
           </div>
       </div>
   </div>
   
   <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
   <script>
       let selectedAvatar = '🐋';
       let licenseNum = generateLicenseNumber();
       let serviceEnabled = true;
       
       // 통계 데이터 초기화
       function initStats() {
           if (!localStorage.getItem('whaleStats')) {
               localStorage.setItem('whaleStats', JSON.stringify({
                   total: 0,
                   today: 0,
                   lastDate: new Date().toDateString(),
                   whaleTypes: {}
               }));
           }
       }
       
       // 초기화
       window.onload = function() {
           initStats();
           updateLicense();
           generateBarcode();
           document.getElementById('issueDate').textContent = formatDate(new Date());
           document.getElementById('expiryDate').textContent = formatDate(getExpiryDate());
           document.getElementById('licenseNumber').textContent = licenseNum;
           
           // URL 파라미터 체크 (관리자 모드)
           const urlParams = new URLSearchParams(window.location.search);
           if (urlParams.get('admin') === 'true') {
               setTimeout(() => {
                   toggleAdmin();
               }, 500);
           }
           
           // 통계 업데이트
           updateStats();
           
           // 서비스 상태 체크
           checkServiceStatus();
           
           // 방문 기록
           recordVisit();
       };
       
       // 방문 기록 함수
       function recordVisit() {
           const visits = parseInt(localStorage.getItem('totalVisits') || '0');
           localStorage.setItem('totalVisits', visits + 1);
           
           // 첫 방문자 환영
           if (visits === 0) {
               setTimeout(() => {
                   alert('🐋 환영합니다! 울산 고래면허증을 발급받고 특별한 혜택을 누려보세요!');
               }, 1000);
           }
       }
       
       // 서비스 상태 체크
       function checkServiceStatus() {
           const status = localStorage.getItem('serviceStatus');
           if (status === 'stopped') {
               serviceEnabled = false;
               document.getElementById('serviceBanner').style.display = 'block';
               document.querySelector('.btn-download').disabled = true;
               document.querySelector('.btn-download').style.opacity = '0.5';
           }
       }
       
       // 통계 업데이트
       function updateStats() {
           const stats = JSON.parse(localStorage.getItem('whaleStats'));
           
           // 날짜 체크 (오늘 통계 리셋)
           if (stats.lastDate !== new Date().toDateString()) {
               stats.today = 0;
               stats.lastDate = new Date().toDateString();
           }
           
           document.getElementById('todayCount').textContent = stats.today;
           document.getElementById('totalCount').textContent = stats.total;
           
           // 인기 고래 계산
           if (Object.keys(stats.whaleTypes).length > 0) {
               const popular = Object.entries(stats.whaleTypes)
                   .sort(([,a], [,b]) => b - a)[0];
               document.getElementById('popularWhale').textContent = popular[0];
           }
           
           localStorage.setItem('whaleStats', JSON.stringify(stats));
       }
       
       // 발급 시 통계 기록
       function recordLicense() {
           const stats = JSON.parse(localStorage.getItem('whaleStats'));
           stats.total++;
           stats.today++;
           
           const whaleType = document.getElementById('whaleType').value;
           if (whaleType) {
               stats.whaleTypes[whaleType] = (stats.whaleTypes[whaleType] || 0) + 1;
           }
           
           localStorage.setItem('whaleStats', JSON.stringify(stats));
           updateStats();
       }
       
       // 관리자 패널 토글
       function toggleAdmin() {
           const panel = document.getElementById('adminPanel');
           const isOpen = panel.style.display === 'block';
           
           if (!isOpen) {
               const password = prompt('관리자 비밀번호를 입력하세요:');
               if (password !== '1633') {
                   alert('비밀번호가 틀렸습니다.');
                   return;
               }
           }
           
           panel.style.display = isOpen ? 'none' : 'block';
           updateStats();
       }
       
       // 서비스 토글
       function toggleService() {
           serviceEnabled = !serviceEnabled;
           localStorage.setItem('serviceStatus', serviceEnabled ? 'active' : 'stopped');
           
           const banner = document.getElementById('serviceBanner');
           banner.style.display = serviceEnabled ? 'none' : 'block';
           
           const btn = document.getElementById('serviceToggle');
           btn.textContent = serviceEnabled ? '🚫 발급 중지' : '✅ 발급 재개';
           
           alert(serviceEnabled ? '서비스가 재개되었습니다.' : '서비스가 중지되었습니다.');
       }
       
       // 중지 예약
       function scheduleStop() {
           const time = prompt('몇 시간 후에 중지하시겠습니까? (숫자만 입력)');
           if (time) {
               alert(`${time}시간 후에 서비스가 중지됩니다.`);
               setTimeout(() => {
                   toggleService();
               }, time * 3600000);
           }
       }
       
       // 통계 초기화
       function resetStats() {
           if (confirm('정말로 모든 통계를 초기화하시겠습니까?')) {
               localStorage.setItem('whaleStats', JSON.stringify({
                   total: 0,
                   today: 0,
                   lastDate: new Date().toDateString(),
                   whaleTypes: {}
               }));
               updateStats();
               alert('통계가 초기화되었습니다.');
           }
       }
       
       // 데이터 내보내기
       function exportData() {
           const stats = JSON.parse(localStorage.getItem('whaleStats'));
           const applications = JSON.parse(localStorage.getItem('couponApplications') || '[]');
           
           const data = `울산 고래면허증 통계 리포트
생성일: ${new Date().toLocaleString()}

[발급 현황]
- 전체 발급: ${stats.total}건
- 오늘 발급: ${stats.today}건
- 쿠폰 신청: ${stats.couponApplications || 0}건

[고래별 통계]
${Object.entries(stats.whaleTypes || {}).map(([type, count]) => 
   `- ${type}: ${count}건`).join('\n')}

[쿠폰 사전신청 목록]
${applications.map((app, idx) => 
   `${idx + 1}. ${app.name} / ${app.contactType === 'phone' ? '📱' : '💬'} ${app.contact} / ${new Date(app.timestamp).toLocaleString()}`
).join('\n')}

[서비스 상태]
- 현재: ${serviceEnabled ? '정상 운영' : '일시 중지'}
`;
           
           const blob = new Blob([data], { type: 'text/plain' });
           const url = URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url;
           a.download = `고래면허증_통계_${new Date().toLocaleDateString()}.txt`;
           a.click();
       }
       
       // 쿠폰 표시
       function showCoupon() {
           document.getElementById('couponModal').style.display = 'flex';
           document.getElementById('couponForm').style.display = 'block';
           document.getElementById('couponSuccess').style.display = 'none';
           document.getElementById('couponForm').reset();
       }
       
       // 쿠폰 닫기
       function closeCoupon(event) {
           if (!event || event.target === document.getElementById('couponModal')) {
               document.getElementById('couponModal').style.display = 'none';
           }
       }
       
       // 연락처 입력 토글
       function toggleContactInput() {
           const contactType = document.querySelector('input[name="contactType"]:checked').value;
           document.getElementById('phoneNumber').style.display = contactType === 'phone' ? 'block' : 'none';
           document.getElementById('kakaoId').style.display = contactType === 'kakao' ? 'block' : 'none';
       }
       
       // 쿠폰 폼 제출
       document.getElementById('couponForm').addEventListener('submit', function(e) {
           e.preventDefault();
           
           if (!document.getElementById('agreeTerms').checked) {
               alert('개인정보 수집 및 이용에 동의해주세요.');
               return;
           }
           
           // 데이터 수집
           const contactType = document.querySelector('input[name="contactType"]:checked').value;
           const formData = {
               name: document.getElementById('userName').value,
               contactType: contactType,
               contact: contactType === 'phone' 
                   ? document.getElementById('phoneNumber').value 
                   : document.getElementById('kakaoId').value,
               timestamp: new Date().toISOString(),
               whaleType: document.getElementById('whaleType').value || '미선택',
               purpose: document.getElementById('experience').value || '미선택'
           };
           
           // 로컬 저장
           let applications = JSON.parse(localStorage.getItem('couponApplications') || '[]');
           applications.push(formData);
           localStorage.setItem('couponApplications', JSON.stringify(applications));
           
           // 성공 화면 표시
           document.getElementById('couponForm').style.display = 'none';
           document.getElementById('couponSuccess').style.display = 'block';
           
           // 통계 업데이트
           const stats = JSON.parse(localStorage.getItem('whaleStats'));
           stats.couponApplications = (stats.couponApplications || 0) + 1;
           localStorage.setItem('whaleStats', JSON.stringify(stats));
       });
       
       // SNS 공유
       function shareToSNS() {
           const text = '나도 울산 고래면허증 발급받았다! 🐋\n나의 고래: ' + selectedAvatar;
           const url = window.location.href.split('?')[0];
           
           const shareOptions = `공유할 플랫폼을 선택하세요:
1. 카카오톡 (모바일)
2. 페이스북
3. 트위터
4. 링크 복사
5. QR코드 생성`;
           
           const choice = prompt(shareOptions);
           
           switch(choice) {
               case '1':
                   if (/mobile/i.test(navigator.userAgent)) {
                       window.location.href = `kakaolink://send?text=${encodeURIComponent(text + '\n' + url)}`;
                   } else {
                       alert('카카오톡 공유는 모바일에서만 가능합니다.');
                   }
                   break;
               case '2':
                   window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`);
                   break;
               case '3':
                   window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`);
                   break;
               case '4':
                   navigator.clipboard.writeText(url).then(() => {
                       alert('링크가 복사되었습니다! 📋\n\n' + url);
                   });
                   break;
               case '5':
                   window.open(`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(url)}`);
                   break;
           }
       }
       
       // 아바타 선택
       function selectAvatar(avatar, element) {
           selectedAvatar = avatar;
           
           document.querySelectorAll('.avatar-option').forEach(opt => {
               opt.classList.remove('selected');
           });
           
           element.classList.add('selected');
           updateLicense();
       }
       
       // 실시간 면허증 업데이트
       function updateLicense() {
           const name = document.getElementById('name').value || '-';
           document.getElementById('displayName').textContent = name;
           
           const birthdate = document.getElementById('birthdate').value;
           document.getElementById('displayBirth').textContent = birthdate ? formatDate(birthdate) : '-';
           
           const whaleType = document.getElementById('whaleType').value || '-';
           document.getElementById('displayWhale').textContent = whaleType;
           
           const experience = document.getElementById('experience').value || '-';
           document.getElementById('displayGrade').textContent = experience.split(' ')[0];
           
           document.getElementById('avatarDisplay').textContent = selectedAvatar;
       }
       
       // 면허증 번호 생성
       function generateLicenseNumber() {
           const year = new Date().getFullYear();
           const random = Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
           return `UW-${year}-${random}`;
       }
       
       // 날짜 포맷
       function formatDate(date) {
           const d = new Date(date);
           const year = d.getFullYear();
           const month = String(d.getMonth() + 1).padStart(2, '0');
           const day = String(d.getDate()).padStart(2, '0');
           return `${year}.${month}.${day}`;
       }
       
       // 유효기간 (5년 후)
       function getExpiryDate() {
           const today = new Date();
           return new Date(today.getFullYear() + 5, today.getMonth(), today.getDate());
       }
       
       // 바코드 생성
       function generateBarcode() {
           const barcode = document.getElementById('barcode');
           barcode.innerHTML = '';
           
           for (let i = 0; i < 25; i++) {
               const line = document.createElement('div');
               line.className = 'barcode-line';
               line.style.height = (Math.random() * 20 + 20) + 'px';
               barcode.appendChild(line);
           }
       }
       
       // 다운로드 기능
       function downloadLicense() {
           if (!serviceEnabled) {
               alert('현재 서비스가 중지되어 발급이 불가능합니다.');
               return;
           }
           
           recordLicense();
           
           const licenseCard = document.querySelector('.license-card');
           
           html2canvas(licenseCard, {
               backgroundColor: '#ffffff',
               scale: 2,
               logging: false,
               useCORS: true
           }).then(canvas => {
               canvas.toBlob(blob => {
                   const url = URL.createObjectURL(blob);
                   const a = document.createElement('a');
                   a.href = url;
                   a.download = `울산고래면허증_${document.getElementById('displayName').textContent}_${licenseNum}.png`;
                   a.click();
                   URL.revokeObjectURL(url);
                   
                   alert('🐋 고래면허증이 이미지로 저장되었습니다! 갤러리에서 확인하세요.');
               }, 'image/png');
           }).catch(err => {
               console.error('이미지 생성 중 오류:', err);
               downloadAsText();
           });
       }
       
       // 텍스트 다운로드 (대체 방법)
       function downloadAsText() {
           const licenseData = {
               이름: document.getElementById('displayName').textContent,
               생년월일: document.getElementById('displayBirth').textContent,
               고래종류: document.getElementById('displayWhale').textContent,
               운전목적: document.getElementById('displayGrade').textContent,
               발급일: document.getElementById('issueDate').textContent,
               유효기간: document.getElementById('expiryDate').textContent,
               면허번호: document.getElementById('licenseNumber').textContent,
               프로필: selectedAvatar
           };
           
           let content = '🐋 울산 고래면허증 🐋\n\n';
           for (const [key, value] of Object.entries(licenseData)) {
               content += `${key}: ${value}\n`;
           }
           content += '\n주의: 이 면허증으로 실제 고래를 운전하면 곤란합니다! 😄';
           
           const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
           const url = URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url;
           a.download = `고래면허증_${licenseData.이름}_${licenseData.면허번호}.txt`;
           a.click();
           URL.revokeObjectURL(url);
       }
   </script>
</body>
</html>
